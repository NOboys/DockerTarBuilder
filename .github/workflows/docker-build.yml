name: General Docker Build (No Push)

on:
  # æ¨èæ‰‹åŠ¨è§¦å‘ï¼Œå¯ä¼ å…¥è‡ªå®šä¹‰å‚æ•°
  workflow_dispatch:
    inputs:
      dockerfile_path:
        description: 'Dockerfileè·¯å¾„ï¼ˆç›¸å¯¹äºä»“åº“æ ¹ç›®å½•ï¼‰'
        required: true
        default: 'work/dockerfile'
        type: string
      image_name:
        description: 'æ„å»ºå‡ºçš„é•œåƒåç§°ï¼ˆä»…æœ¬åœ°æ ‡ç­¾ç”¨ï¼‰'
        required: true
        default: 'custom-built-image'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    # æ¯ä¸ªjobéƒ½åœ¨ä¸€ä¸ªå…¨æ–°çš„ã€éš”ç¦»çš„è™šæ‹Ÿè¿è¡Œå™¨ä¸­æ‰§è¡Œï¼Œç¯å¢ƒç‹¬ç«‹
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # ä»…åœ¨å½“å‰è¿è¡Œå™¨å†…è®¾ç½®Buildxï¼Œä¸å½±å“å¤–éƒ¨

      - name: Validate Dockerfile
        run: |
          if [ ! -f "${{ github.event.inputs.dockerfile_path }}" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æ–‡ä»¶ ${{ github.event.inputs.dockerfile_path }}"
            exit 1
          fi
          echo "âœ… Dockerfileè·¯å¾„æœ‰æ•ˆã€‚"

      # æ ¸å¿ƒï¼šæ„å»ºä½†ä¸æ¨é€
      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ github.event.inputs.dockerfile_path }}
          push: false
          tags: ${{ github.event.inputs.image_name }}:latest
          # å…³é”®ï¼šç¼“å­˜ä»…ä¿å­˜åœ¨æœ¬å·¥ä½œæµå®šä¹‰çš„ä¸´æ—¶ç›®å½•ä¸­
          cache-from: type=gha, scope=${{ github.workflow }}-${{ github.event.inputs.dockerfile_path }}
          cache-to: type=gha, scope=${{ github.workflow }}-${{ github.event.inputs.dockerfile_path }}, mode=max
          outputs: type=docker, dest=/tmp/image_${{ github.run_id }}.tar
          # å¦‚æœæ‚¨éœ€è¦ä¼ é€’æ„å»ºå‚æ•°ï¼Œå¯ä»¥åœ¨æ­¤æ·»åŠ ï¼Œä¾‹å¦‚ï¼š
          # build-args: |
          #   ARG1=value1

      # å¯é€‰ï¼šå°†é•œåƒæ‰“åŒ…ä¸ºå·¥ä»¶ï¼Œ6å°æ—¶åè‡ªåŠ¨åˆ é™¤
      - name: Upload Image as Temporary Artifact
        if: success() # ä»…åœ¨æ„å»ºæˆåŠŸåä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-${{ github.run_id }}
          path: /tmp/image_${{ github.run_id }}.tar
          retention-days: 0.25 # 6å°æ—¶åè‡ªåŠ¨åˆ é™¤
          compression-level: 9

      # ğŸ”’ å®‰å…¨ä¸”éš”ç¦»çš„æ¸…ç†æ­¥éª¤
      - name: Cleanup (Scoped to This Run)
        if: always() # æ— è®ºæ„å»ºæˆåŠŸä¸å¦éƒ½æ‰§è¡Œæ¸…ç†
        run: |
          echo "å¼€å§‹æ‰§è¡Œéš”ç¦»æ¸…ç†..."
          
          # 1. ä»…åˆ é™¤æœ¬æ¬¡è¿è¡Œåˆ›å»ºçš„ã€æ˜ç¡®çŸ¥é“çš„ä¸´æ—¶æ–‡ä»¶
          echo "åˆ é™¤æœ¬æ¬¡è¿è¡Œçš„ä¸´æ—¶æ–‡ä»¶..."
          rm -f /tmp/image_${{ github.run_id }}.tar
          
          # 2. æ¸…ç†æœ¬æ¬¡æ„å»ºå¯èƒ½äº§ç”Ÿçš„Dockeræ‚¬ç©ºé•œåƒï¼ˆéå¸¸å®‰å…¨ï¼Œä¸å½±å“ä»–äººï¼‰
          # `docker image prune -f` ä»…åˆ é™¤æ‚¬ç©ºçš„ï¼ˆæ²¡æœ‰æ ‡ç­¾ä¸”æœªè¢«ä»»ä½•å®¹å™¨å¼•ç”¨ï¼‰çš„é•œåƒ
          # è¿™äº›é•œåƒä»…ç”±æœ¬æ¬¡æ„å»ºè¿‡ç¨‹äº§ç”Ÿï¼Œä¸ä¼šè§¦åŠä»–äººé•œåƒ
          echo "æ¸…ç†æ‚¬ç©ºçš„Dockeré•œåƒå±‚..."
          docker image prune -f
          
          # 3. ï¼ˆå¯é€‰ï¼‰è¾“å‡ºæ¸…ç†æŠ¥å‘Šï¼Œç¡®è®¤å½±å“èŒƒå›´
          echo "=== æ¸…ç†å®ŒæˆæŠ¥å‘Š ==="
          echo "å·¥ä½œæµIDï¼š${{ github.run_id }}"
          echo "æ¸…ç†èŒƒå›´ï¼šä»…é™æœ¬æ¬¡ä»»åŠ¡åˆ›å»ºçš„ä¸´æ—¶æ–‡ä»¶å’Œæ‚¬ç©ºé•œåƒå±‚"
          echo "æç¤ºï¼šGitHub Actionsè¿è¡Œå™¨åœ¨ä»»åŠ¡ç»“æŸåå°†è¢«æ•´ä½“é”€æ¯ï¼Œæ‰€æœ‰å‰©ä½™æ–‡ä»¶ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚"
